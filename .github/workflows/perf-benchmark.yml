name: Performance benchmark

on:
  workflow_dispatch:

permissions:
  packages: write
  checks: write

jobs:
  update_test_durations:
    runs-on: ubuntu-latest
    env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # ref: main
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Process nightly test durations
        id: get-test-durations
        run: |
          repo="tenstorrent/tt-forge-fe"
          wf_name="on-nightly.yml"
          $conclusions="success,failure"

          # get json of the last 10 workflow runs
          gh run list --workflow $wf_name -R $repo -b main -L 5 --status completed --json attempt,conclusion,databaseId >runs.json

          counter=0
          while true; do
            # Check the status of 'conclusion'
            conclusion=$(jq -r ".[$counter].conclusion" runs.json)

            if echo "$conclusions" | grep -q -w "$conclusion"; then
              break
            else
              ((counter++))

              # Exit if the counter reaches 5
              if [ $counter -ge 5 ]; then
                echo "Counter reached 5. Exiting with code 1."
                exit 1
              fi
            fi
          done
          curr_wf_id=$(jq -r ".[$counter].databaseId" runs.json)
          curr_wf_att=$(jq -r ".[$counter].attempt" runs.json)

          gh run download $curr_wf_id --pattern "test-reports-*" -R $repo -D ${{runner.temp}}/reports
          python .github/workflows/get_test_duration_from_junit_xmls.py ${{runner.temp}}/reports .test_durations_new
          echo "----- NEW DURATIONS"
          cat .test_durations_new

          echo "TODAY=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "curr_wf_link='https://github.com/$repo/actions/runs/$curr_wf_id/attempts/$curr_wf_att'" >> $GITHUB_OUTPUT
