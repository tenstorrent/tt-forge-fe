# This workflow runs a schedule and uses the latest version of tt-mlir (origin/main branch)
# to check if the latest version of tt-mlir is compatible with the current codebase.

name: Nighty Uplift PR

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'
  push:

jobs:    
  uplift-pr:    
    runs-on: ubuntu-latest    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Set env variable
        run: |
          echo "TODAY=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      - name: Create uplift PR
        env:
          GH_TOKEN: ${{ github.token }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          UPLIFT_BRANCH: uplift-${{ env.TODAY }}
          SUBMODULE_PATH: third_party/tt-mlir
          SUBMODULE_VERSION: origin/main
        run: |
            git config --global user.email ${{ vars.INTEGRATION_OWNER }}
            git config --global user.name "Tenstorrent CI"
            if git rev-parse --verify origin/$UPLIFT_BRANCH >/dev/null 2>&1; then
              echo "### Branch $UPLIFT_BRANCH already exists ###"
              exit 0
            fi
            git checkout -b $UPLIFT_BRANCH
            cd $SUBMODULE_PATH
            git fetch origin
            git checkout $SUBMODULE_VERSION
            echo "### Latest commit in $SUBMODULE_PATH ###"
            git log -1
            cd ../..
            if [ -z "$(git status --porcelain)" ]; then
              echo "### No changes in $SUBMODULE_PATH ###"
              exit 0
            fi
            echo "### Commit change and create PR ###"
            git add $SUBMODULE_PATH
            git commit -m "Uplift $SUBMODULE_PATH to $SUBMODULE_VERSION $TODAY"
            git push origin $UPLIFT_BRANCH
            gh pr create \
            --title "Uplift $SUBMODULE_PATH to $SUBMODULE_VERSION $TODAY" \
            --body "This PR uplifts the $SUBMODULE_PATH submodule to the $SUBMODULE_VERSION." \
            --base main \
            --head $UPLIFT_BRANCH \
            --label uplift \
            --reviewer ${{ vars.INTEGRATION_OWNER }}
