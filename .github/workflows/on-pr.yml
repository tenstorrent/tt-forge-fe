name: On PR

on:
  workflow_dispatch:
    inputs:
      mlir_override:
        description: 'Git SHA of commit in tenstorrent/tt-mlir'
        required: false
        type: string
      test_group_cnt:
        description: 'Test group count for models regression tests'
        required: false
        default: "6"
        type: choice
        options:
          - "3"
          - "4"
          - "5"
          - "6"
          - "7"
          - "8"
          - "9"
          - "10"
      enable-verbose-output:
        description: 'Enable verbose pytest output (-svv flag). Shows print statements and detailed test execution information for models regression tests'
        required: false
        default: false
        type: boolean
  pull_request:
    branches: [ "main" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ inputs.mlir_override }}
  cancel-in-progress: true

permissions:
  packages: write
  checks: write
  id-token: write
  actions: write


jobs:
  generate-test-models-config:
    runs-on: ubuntu-latest
    outputs:
      test_group_cnt: ${{ steps.set-config.outputs.test_group_cnt }}
      test_group_ids: ${{ steps.set-config.outputs.test_group_ids }}
      enable_verbose: ${{ steps.set-config.outputs.enable_verbose }}
    steps:
      - name: Generate test-models configuration
        id: set-config
        run: |
          input_test_group_cnt="${{ inputs.test_group_cnt }}"
          if [ -z "$input_test_group_cnt" ] || [ "$input_test_group_cnt" == "null" ]; then
            test_group_cnt="6"
          else
            test_group_cnt="$input_test_group_cnt"
          fi


          test_group_ids="[$(seq -s ',' 1 $test_group_cnt)]"

          input_verbose="${{ inputs.enable-verbose-output }}"
          if [ -z "$input_verbose" ] || [ "$input_verbose" == "null" ]; then
            enable_verbose="true"
          else
            enable_verbose="$input_verbose"
          fi

          echo "test_group_cnt=$test_group_cnt" >> $GITHUB_OUTPUT
          echo "test_group_ids=$test_group_ids" >> $GITHUB_OUTPUT
          echo "enable_verbose=$enable_verbose" >> $GITHUB_OUTPUT

  spdx:
    uses: ./.github/workflows/spdx.yml
    secrets: inherit
  pre-commit:
    uses: ./.github/workflows/pre-commit.yml
    secrets: inherit
  docker-build:
    uses: ./.github/workflows/build-image.yml
    secrets: inherit
    with:
      mlir_override: ${{ inputs.mlir_override }}
  build:
    needs: docker-build
    uses: ./.github/workflows/build.yml
    secrets: inherit
    with:
      mlir_override: ${{ inputs.mlir_override }}
      docker-image: ${{ needs.docker-build.outputs.docker-image }}
  build-docs:
    uses: ./.github/workflows/build-docs.yml
    permissions:
      contents: read
      pages: write
      id-token: write
    secrets: inherit
  test:
    needs:
      - docker-build
      - build
      - generate-test-models-config
    uses: ./.github/workflows/test-sub.yml
    secrets: inherit
    with:
      test_mark: 'push'
      test_group_cnt: 2
      test_group_ids: '[1,2]'
      docker-image: ${{ needs.docker-build.outputs.docker-image }}
      run_id: ${{ github.run_id }}
      runs-on: '[{"runs-on": "n150"}, {"runs-on": "n300"}]'

  test-models:
    needs:
      - docker-build
      - build
      - generate-test-models-config
    uses: ./.github/workflows/test-sub.yml
    secrets: inherit
    with:
      test_mark: 'pr_models_regression'
      test_group_cnt: ${{ needs.generate-test-models-config.outputs.test_group_cnt }}
      test_group_ids: ${{ needs.generate-test-models-config.outputs.test_group_ids }}
      docker-image: ${{ needs.docker-build.outputs.docker-image }}
      run_id: ${{ github.run_id }}
      runs-on: '[{"runs-on": "n150"}, {"runs-on": "n300"}]'
      enable-verbose-output: ${{ needs.generate-test-models-config.outputs.enable_verbose == 'true' }}

  check-all-green:
    if: always()
    needs:
      - generate-test-models-config
      - pre-commit
      - spdx
      - docker-build
      - build-docs
      - build
      - test
      - test-models
    runs-on: Ubuntu-latest
    steps:
    - name: Check if the needed jobs succeeded or failed
      uses: re-actors/alls-green@release/v1
      with:
        jobs: ${{ toJSON(needs) }}
        allowed-skips: perf-benchmark
