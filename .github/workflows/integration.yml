# This workflow runs a schedule and uses the latest version of tt-mlir (origin/main branch)
# to check if the latest version of tt-mlir is compatible with the current codebase.

name: Integration

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'
  push:

jobs:
  docker-build:
    uses: ./.github/workflows/docker-build.yml
    secrets: inherit
    with: 
      tt-mlir-version: 'origin/main'

  notify-failure:
    needs: docker-build
    if: ${{ always() && needs.docker-build.result == 'failure' }}
    runs-on: ubuntu-latest    
    steps:
      - uses: actions/checkout@v4
      - name: Create Issue
        env:
          GH_TOKEN: ${{ github.token }}
          WORKFLOW: ${{ github.workflow }}
          RUN_ID: ${{ github.run_id }}
          RUN_URL: ${{ github.run_url }}
          TODAY: $(date +'%Y-%m-%d')
        run: |
            gh issue create \
            --title "Integration run failed - $TODAY" \
            --body "The Docker build job failed in the Integration workflow.\nWorkflow: $WORKFLOW \nWorkflow Run: $RUN_ID \nWorkflow Run URL: $RUN_URL" \
            --assignee ${{ vars.INTEGRATION_OWNER }}
            
